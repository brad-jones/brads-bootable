---
apiVersion: v1
kind: Namespace
metadata:
  name: goj-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: goj-service-account
  namespace: goj-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: goj-service-account-role
  namespace: goj-system
subjects:
  - kind: ServiceAccount
    name: goj-service-account
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: git-ops-cron-job
  namespace: goj-system
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: goj-service-account
          restartPolicy: Never
          containers:
            - name: git-ops-job
              image: ghcr.io/brad-jones/brads-bootable/goj:latest
              imagePullPolicy: Always
              command: pull
              env:
                - name: GIT_HTTPS_URL
                  value: https://github.com/brad-jones/brads.bootable.git
                - name: GIT_SUB_DIR
                  value: k8s
                - name: GIT_BEARER_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: goj-git-bearer-token
                      key: value
                - name: SOPS_AGE_KEY
                  valueFrom:
                    secretKeyRef:
                      name: goj-sops-age-key
                      key: value
